<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Food System</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f4f4f4;
    }

    /* Layout */
    .menu {
      width: 70%;
      background: #fff;
      padding: 20px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      justify-content: center;
      align-items: center;
      gap: 20px;
    }

    .order {
      width: 30%;
      background: #fafafa;
      border-left: 2px solid #eee;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    /* Food Cards */
    .food {
      flex: 0 0 220px;
      height: 280px;
      background: white;
      border-radius: 15px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .food:hover {
      transform: scale(1.05);
    }
    .food img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 10px;
    }
    .food h3 {
      margin: 10px 0 5px;
      font-size: 18px;
    }
    .food p {
      margin: 5px 0;
      font-size: 14px;
      color: #555;
    }

    /* Orders */
    .order h2 {
      margin-top: 0;
      font-size: 20px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }
    #customerChoice {
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    .order-list {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      font-size: 16px;
      gap: 10px;
    }
    .order-name {
      cursor: pointer;
      flex-grow: 1;
    }
    .remove-btn {
      background: transparent;
      border: none;
      color: #dc3545;
      font-size: 18px;
      cursor: pointer;
    }
    .remove-btn:hover {
      color: #a71d2a;
    }
    .total {
      font-weight: bold;
      font-size: 18px;
      margin: 10px 0;
    }
    .checkout-btn {
      padding: 12px;
      font-size: 16px;
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      border-radius: 8px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      width: 320px;
      text-align: center;
      animation: popIn 0.3s ease;
    }
    @keyframes popIn {
      from { transform: scale(0.7); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .qty-control {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 15px 0;
      gap: 10px;
    }
    .qty-control button {
      width: 40px;
      height: 40px;
      font-size: 20px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 50%;
      cursor: pointer;
    }
    .qty-control input {
      width: 60px;
      text-align: center;
      font-size: 18px;
      padding: 5px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .add-btn {
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    .close-btn {
      margin-top: 10px;
      background: #dc3545;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Thank You Popup */
    .thankyou {
      display: none;
      position: fixed;
      z-index: 2000;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .thankyou-content {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      width: 300px;
      animation: popIn 0.3s ease;
    }
    .thankyou-content img {
      max-width: 200px;
      margin: 15px auto;
      display: block;
    }

    /* Choice Modal Buttons */
    .choice-btn {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: white;
    }
    .choice-makan {
      background: #007bff;
    }
    .choice-bungkus {
      background: #28a745;
    }

    /* NEW Style for Name Input */
    #nameInput {
        padding: 10px; 
        margin: 15px 0; 
        width: 80%; 
        border: 2px solid #ddd;
        border-radius: 8px; 
        font-size: 16px;
        text-align: center;
    }

    @media (max-width: 900px) {
      body { flex-direction: column; }
      .menu, .order {
        width: 100%;
        height: auto;
      }
      .menu {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 600px) {
      .menu {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="menu">
    <div class="food" data-name="Roti Canai" data-price="1.50">
      <img src="Assets/roti-canai.jpg" alt="Roti Canai">
      <h3>Roti Canai</h3>
      <p>RM1.50 / pc</p>
    </div>
    <div class="food" data-name="Satay Ayam" data-price="1.40">
      <img src="Assets/satay-ayam.png" alt="Satay Ayam">
      <h3>Satay Ayam</h3>
      <p>RM1.40 / pc</p>
    </div>
    <div class="food" data-name="Satay Daging" data-price="1.40">
      <img src="Assets/satay-daging.png" alt="Satay Daging">
      <h3>Satay Daging</h3>
      <p>RM1.40 / pc</p>
    </div>
    <div class="food" data-name="Nasi Impit" data-price="1.00">
      <img src="Assets/nasi-impit.png" alt="Nasi Impit">
      <h3>Nasi Impit</h3>
      <p>RM1.00 / pc</p>
    </div>
  </div>

  <div class="order">
    <h2>Pesanan Anda</h2>
    <p id="customerChoice"></p>
    <div class="order-list" id="orderList"></div>
    <div class="total" id="totalAmount">Jumlah: RM0.00</div>
    <button class="checkout-btn" id="checkoutBtn">Selesai</button>
  </div>

  <div id="foodModal" class="modal">
    <div class="modal-content">
      <h3 id="modalFoodName"></h3>
      <p id="modalFoodPrice"></p>
      <div class="qty-control">
        <button id="decreaseQty">-</button>
        <input type="number" id="qtyInput" value="1" min="1">
        <button id="increaseQty">+</button>
      </div>
      <button class="add-btn" id="addToOrder">Tambah ke Pesanan</button><br>
      <button class="close-btn" id="closeModal">Batal</button>
    </div>
  </div>

  <div id="choiceModal" class="modal">
    <div class="modal-content">
      <h3>Makan sini atau Bungkus?</h3>
      <button class="choice-btn choice-makan" onclick="setChoice('Makan Sini')">Makan Sini</button>
      <button class="choice-btn choice-bungkus" onclick="setChoice('Bungkus')">Bungkus</button>
    </div>
  </div>

  <div id="nameModal" class="modal">
    <div class="modal-content">
      <h3>Sila masukkan nama anda</h3>
      <input type="text" id="nameInput" placeholder="Contoh: Meor Azlan">
      <button class="add-btn" id="confirmNameBtn">Sahkan Pesanan</button>
      <button class="close-btn" id="closeNameModal">Batal</button>
    </div>
  </div>
  
  <div id="thankyouModal" class="thankyou">
    <div class="thankyou-content">
      <h3>Terima Kasih!</h3>
      <p id="finalTotal"></p>
      <img src="Assets/qr-payment.jpg" alt="QR Payment">
      <button class="close-btn" id="closeThankyou">Tutup</button>
    </div>
  </div>

<script>
  const foods = document.querySelectorAll('.food');
  const modal = document.getElementById('foodModal');
  const modalFoodName = document.getElementById('modalFoodName');
  const modalFoodPrice = document.getElementById('modalFoodPrice');
  const qtyInput = document.getElementById('qtyInput');
  const increaseQtyBtn = document.getElementById('increaseQty');
  const decreaseQtyBtn = document.getElementById('decreaseQty');
  const addToOrderBtn = document.getElementById('addToOrder');
  const closeModalBtn = document.getElementById('closeModal');
  const orderList = document.getElementById('orderList');
  const totalAmount = document.getElementById('totalAmount');
  const checkoutBtn = document.getElementById('checkoutBtn');
  const thankyouModal = document.getElementById('thankyouModal');
  const finalTotal = document.getElementById('finalTotal');
  const closeThankyouBtn = document.getElementById('closeThankyou');
  const choiceModal = document.getElementById('choiceModal');
  const customerChoiceDisplay = document.getElementById('customerChoice');

  // NEW ELEMENTS
  const nameModal = document.getElementById('nameModal');
  const nameInput = document.getElementById('nameInput');
  const confirmNameBtn = document.getElementById('confirmNameBtn');
  const closeNameModal = document.getElementById('closeNameModal');


  let currentFood = null;
  let orders = [];
  let customerChoice = null;
  let editingIndex = null;

  foods.forEach(food => {
    food.addEventListener('click', () => {
      currentFood = {
        name: food.dataset.name,
        price: parseFloat(food.dataset.price)
      };
      if (!customerChoice) {
        choiceModal.style.display = 'flex';
      } else {
        openFoodModal();
      }
    });
  });

  function setChoice(choice) {
    customerChoice = choice;
    customerChoiceDisplay.textContent = `Pilihan: ${choice}`;
    choiceModal.style.display = 'none';
    openFoodModal();
  }

  function openFoodModal() {
    qtyInput.value = editingIndex !== null ? orders[editingIndex].qty : 1;
    modalFoodName.textContent = currentFood.name;
    modalFoodPrice.textContent = `Harga: RM${currentFood.price.toFixed(2)} / pc`;
    modal.style.display = 'flex';
  }

  increaseQtyBtn.addEventListener('click', () => {
    qtyInput.value = parseInt(qtyInput.value) + 1;
  });

  decreaseQtyBtn.addEventListener('click', () => {
    if (parseInt(qtyInput.value) > 1) {
      qtyInput.value = parseInt(qtyInput.value) - 1;
    }
  });

  addToOrderBtn.addEventListener('click', () => {
    const qty = parseInt(qtyInput.value);
    if (qty > 0) {
      if (editingIndex !== null) {
        orders[editingIndex].qty = qty;
        editingIndex = null;
      } else {
        // Check if item already exists to merge the order
        const existingOrderIndex = orders.findIndex(item => item.name === currentFood.name);
        
        if (existingOrderIndex > -1) {
            orders[existingOrderIndex].qty += qty;
        } else {
            orders.push({ name: currentFood.name, price: currentFood.price, qty });
        }
      }
      renderOrders();
      modal.style.display = 'none';
    }
  });

  closeModalBtn.addEventListener('click', () => {
    modal.style.display = 'none';
    editingIndex = null;
  });

  function renderOrders() {
    orderList.innerHTML = '';
    let total = 0;
    orders.forEach((order, index) => {
      const item = document.createElement('div');
      item.className = 'order-item';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'order-name';
      nameSpan.textContent = `${order.qty} x ${order.name}`;
      nameSpan.onclick = () => editOrder(index);

      const priceSpan = document.createElement('span');
      priceSpan.textContent = "RM" + (order.price * order.qty).toFixed(2);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'remove-btn';
      removeBtn.textContent = 'ðŸ—‘ï¸';
      removeBtn.onclick = () => {
        orders.splice(index, 1);
        renderOrders();
      };

      item.appendChild(nameSpan);
      item.appendChild(priceSpan);
      item.appendChild(removeBtn);
      orderList.appendChild(item);
      total += order.price * order.qty;
    });
    totalAmount.textContent = `Jumlah: RM${total.toFixed(2)}`;
  }

  function editOrder(index) {
    currentFood = orders[index];
    editingIndex = index;
    openFoodModal();
  }

  // --- NEW Checkout Workflow START ---

  checkoutBtn.addEventListener('click', () => {
    // Check if an order exists
    if (orders.length === 0) {
        alert("Sila tambah item ke pesanan anda dahulu.");
        return;
    }
    // Open the Name Modal
    nameModal.style.display = 'flex';
    nameInput.value = ''; // Clear previous name
  });

  closeNameModal.addEventListener('click', () => {
    nameModal.style.display = 'none';
  });

  // Supabase initialization (unchanged)
  const supabaseClient = supabase.createClient(
    'https://sdzwrpqyhxsljtnndwwz.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkendycHF5aHhzbGp0bm5kd3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NzUzNDksImV4cCI6MjA3NTE1MTM0OX0.KwW62zUh_bfaBGO0q5-usyMtYsBrfDUbdj30zxx4Dfk'
  );

  confirmNameBtn.addEventListener('click', async () => {
    const customerName = nameInput.value.trim();

    if (!customerName) {
        alert("Sila masukkan nama anda untuk pesanan ini.");
        return;
    }

    nameModal.style.display = 'none'; // Hide name modal

    let total = orders.reduce((sum, order) => sum + order.price * order.qty, 0);
    finalTotal.textContent = `Jumlah Akhir: RM${total.toFixed(2)}`;
    
    // Send order to supabase
    const { data, error } = await supabaseClient
      .from('orders')
      .insert([
        {
          choice: customerChoice,
          customer_name: customerName, // <--- NEW DATA FIELD ADDED
          items: orders, // stored as JSON
          total: total,
          created_at: new Date().toISOString()
        }
      ]);

    if (error) {
      console.error("Failed to save order:", error);
      alert("Gagal menyimpan pesanan. Sila cuba lagi.");
    } else {
      console.log("Order saved:", data);
      // Show Thank You Modal only upon successful insertion
      thankyouModal.style.display = 'flex';
    }
  });

  // --- NEW Checkout Workflow END ---

  closeThankyouBtn.addEventListener('click', () => {
    thankyouModal.style.display = 'none';
    orders = [];
    customerChoice = null;
    editingIndex = null;
    customerChoiceDisplay.textContent = '';
    
    // Clear the name input as well
    nameInput.value = ''; 
    
    renderOrders();
  });
  
</script>

</body>
</html>